# Satellite 6.x PKI Authentication

These procedures will enable Satellite 6.x to support authentication using a user PKI certificate that is trusted by a central CA. Authorization will take place using an LDAP group that the particular user belongs to. LDAP and CA functionality are inherited from the environment.

Out of the box, Satellite 6 will not support external authentication and authorisation methods. Foreman, the central UI component of Satellite contains the configuration necessary to make this type of log-in supported.

## Authentication
The authentication piece of Satellite is simple as switching `SSLVerifyClient` to *require* and configure the CA.

1. First, update your certificates on Satellite to use the ones given by the CA.
```
# katello-installer --certs-server-cert /root/server-cert.pem --certs-server-jey /root/privateKey.key --certs-server-cert-req /root/CSR.csr --certs-server-ca-cert /root/ca.crt --certs-update-server --certs-update-server-ca
```

2. On your Satellite instance, edit the file `/etc/httpd/conf.d/05-foreman-ssl.conf`
```
<VirtualHost *:443>
...
	SSLUserName				SSL_CLIENT_S_DN_CN
	SSLVerifyClient			optional
	SSLVerifyDepth			3
	SSLOptions +StdEnvVars +ExportCertData
	
	Redirect permanent /users/login https://satellite.example.com/users/extlogin
	<Location /users/extlogin>
		SSLVerifyClient		require
	</Location>
...
</VirtualHost>
```
. Add the SSL options to use the CN of the certificate as its username
. Add the redirect to disable password-based authentication
. Create the location declaration within the default VirtualHost. This is the special path for Forman to handle external login.

3. WIth the Satellite server ready, append the CA chain to the CA generated by Katello.
```
# cat /root/ca.crt >> /etc/pki/katello/certs/katello-default-ca.crt
```
Now Katello will be able to trust our machines since it is appending the custom CA to the chain

4. Restart Apache on the Satellite server to reload the certificates.
```
# systemctl restart httpd
```

5. Configure Foreman to trust the authentication done in Apache and to automatically generate users who do not exist already by adding the items:
Modify `/etc/foreman/settings.yaml`
```
:authorize_login_delegation: true
:authorize_login_delegation_auth_source_user_autocreate: External
```
Not all certificates will contain a clean usable CN for Foreman to use. It is recommended to ad the following patch to remove spaces from the CN of your certificate.
Modify `/usr/share/foreman/app/services/sso/apache.rb:30`
```
return false unless (self.user = request.env[CAS_USERNAME].nil? ? request.env[CAS_USERNAME] : request.env[CAS_USERNAME].gsub(" ","_"))
```

6. Restart Foreman
```
# katello-service restart
```

## Authorization

The Foreman documentation https://theforeman.org/manuals/1.7/index.html:ExternalAuthentication contains an example using Kerberos. This is a modified version using LDAP instead.

1. Install the ldap authorisation plugin for Apache
```
# yum install mod_ldap
```

2. On Satellite, modify the existing Location entry to add the appropriate LDAP verification step.
```
LoadModule ldap_module modules/mod_ldap.so
LoadModule authnz_ldap_module modules/mod_authnz_ldap.so

<VirtualHost *:443>
...
	<LocationMatch ^/users/(ext)?login$>
		SSLVerifyClient				require
		AuthType					basic
		ErrorDocument				500 "<html><body>Error authentication LDAP</body></html>"
		ErrorDocument				401 "<html><body>Error authentication LDAP</body></html>"
		AuthName 					"LDAP Login"
		AuthBasicProvider 			ldap
		AuthLDAPRemoteUserAttribute	username
		AuthLDAPURL "ldaps://ldap.example.com:636/dc=users,dc=example,dc=com?userName,userEmail,givenname,sn??(ou:dn:=SatelliteUsers)"
		
		<RequireAll>
			Require valid-user
		</RequireAll>
		
		LookupUserAttr email REMOTE_USER_EMAIL ""
		LookupUserAttr firstname REMOTE_USER_FIRSTNAME
		LookupUserAttr lastname REMOTE_USER_LASTNAME
	</LocationMatch>
	...
</VirtualHost>
```
Set `AuthLDAPURI to what needs to be specified. This example limits to users belonging to the *SatelliteUsers* group.

3. Modify the file below so the SSL options do not overwrite what has been set previously.
Modify `/etc/httpd/conf.d/05-foreman-ssl.d/katello.conf`
```
Alias /pub /var/www/html/pub
<Location /pub>
	SSLOptions +StdEnvVars +ExportCertData +FakeBasicAuth
	PassengerEnabled off
	Options +FollowSymLinks +Indexes
</Location>
<LocationMatch /rhsm|/subscription|/katello/api>
	SSLOptions +StdEnvVars +ExportCertData +FakeBasicAuth
	# If ssl_client_certa is present set the header, otherwise don't override.
	# A reverse-proxy may already be sending the cert through its header
	SetEnvIf SSL_CLIENT_CERT "^..*" client_cert_present=1
	RequestHeader set SSL_CLIENT_CERT "%{SSL_CLIENT_CERT}s" env=!client_cert_present
	SSLVerifyClient optional
	SSLRenegBufferSize 16777216
	SSLVerifyDepyh 2
	# Report to CLI and RHSM nicely when Katello is down
	ErrorDocument 500 '{"displayMessage": "Internal error, contact administrator", "errors": ["Internal error, contact administrator"], "status": "500" }'
	ErrorDocument 503 '{"displayMessage": "Service unavailable or restart, try later", "errors": ["Service unavailable or restart, try later"], "status": "503" }'
</LocationMatch>
```
Notice the *SSLOptions* line has been moved form outside to inside the two locations. This is so the *+FakeBasicAuth* statement doesn't undo what was set in the first Apache config.

4. Restart Apache
```
# systemctl restart httpd
```



